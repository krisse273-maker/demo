<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Global Food Share</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
      <h1>üåç Global Food Share</h1>
      <p id="welcomeMsg">Welcome! Find and share food near you!</p>
      <button id="logoutBtn" style="margin-top: 1rem; padding: 0.5rem 1rem; border-radius: 6px; border: none; background-color: white; color: #4caf50; cursor: pointer;">Log Out</button>
    </header>

    <section class="filters">
      <h2>Filter by Location</h2>
      <div class="filter-group">
        <label for="country">Country:</label>
        <select id="country">
          <option value="">Select country</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="city">City:</label>
        <select id="city" disabled>
          <option value="">Select city</option>
        </select>
      </div>
      <div style="margin-top: 1rem">
        <button id="filterBtn" style="padding: 0.5rem 1rem; border-radius: 6px; border: none; background-color: #4caf50; color: white; cursor: pointer;">Search</button>
        <button id="myFoodBtn" style="padding: 0.5rem 1rem; border-radius: 6px; border: none; background-color: #ff9800; color: white; cursor: pointer; margin-left: 0.5rem;">My Food List</button>
      </div>
    </section>

    <section class="food-list">
      <h2>Available Food</h2>
      <div class="global-food-list"></div>
    </section>

    <footer>
      <p>&copy; 2026 Global Food Share</p>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
      // ===== Firebase-konfiguration =====
      const firebaseConfig = {
        apiKey: "AIzaSyCrN3PoqcVs2AbEPbHjfM92_35Uaa1uAYw",
        authDomain: "global-food-share.firebaseapp.com",
        projectId: "global-food-share",
        storageBucket: "global-food-share.appspot.com",
        messagingSenderId: "902107453892",
        appId: "1:902107453892:web:dd9625974b8744cc94ac91"
      };
      firebase.initializeApp(firebaseConfig);

      const auth = firebase.auth();
      const db = firebase.firestore();

      const logoutBtn = document.getElementById("logoutBtn");
      const myFoodBtn = document.getElementById("myFoodBtn");
      const countrySelect = document.getElementById("country");
      const citySelect = document.getElementById("city");
      const filterBtn = document.getElementById("filterBtn");
      const foodList = document.querySelector(".global-food-list");

      let countriesData = [];
      let allFoods = [];

      // ===== Kontrollera om anv√§ndaren √§r inloggad =====
      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          window.location.href = "login.html";
          return;
        }

        // Visa v√§lkomstmeddelande
        document.getElementById("welcomeMsg").textContent = `Welcome, ${user.displayName || user.email}!`;

        // Ladda l√§nder + st√§der
        await loadCountries();

        // Ladda global matlista
        loadGlobalFood();
      });

      // ===== Logout knapp =====
      logoutBtn.addEventListener("click", () => {
        auth.signOut().then(() => {
          window.location.href = "login.html";
        });
      });

      // ===== MyFood knapp =====
      myFoodBtn.addEventListener("click", () => {
        window.location.href = "myfood.html";
      });

      // ===== Ladda l√§nder =====
      async function loadCountries() {
        try {
          const res = await fetch("https://countriesnow.space/api/v0.1/countries");
          const data = await res.json();
          countriesData = data.data;

          countrySelect.innerHTML = '<option value="">Select country</option>';
          countriesData.forEach(c => {
            const opt = document.createElement("option");
            opt.value = c.country;
            opt.textContent = c.country;
            countrySelect.appendChild(opt);
          });
          countrySelect.disabled = false;
        } catch (err) {
          console.error("Could not fetch countries:", err);
          alert("Failed to load countries. Try refreshing.");
        }
      }

      countrySelect.addEventListener("change", () => {
        citySelect.innerHTML = '<option value="">Select city</option>';
        citySelect.disabled = true;

        const selectedCountry = countrySelect.value;
        if (!selectedCountry) return;

        const countryObj = countriesData.find(c => c.country === selectedCountry);
        if (!countryObj || !countryObj.cities.length) return;

        countryObj.cities.forEach(city => {
          const opt = document.createElement("option");
          opt.value = city;
          opt.textContent = city;
          citySelect.appendChild(opt);
        });
        citySelect.disabled = false;
      });

      // ===== Filterknapp =====
      filterBtn.addEventListener("click", () => {
        const country = countrySelect.value;
        const city = citySelect.value;

        const filtered = allFoods.filter(f =>
          (!country || f.country === country) &&
          (!city || f.city === city)
        );

        renderFoodItems(filtered);
      });

      // ===== H√§mta global matlista fr√•n publicFoods =====
      function loadGlobalFood() {
        db.collection("publicFoods")
          .orderBy("timestamp", "desc")
          .onSnapshot(snapshot => {
            allFoods = snapshot.docs.map(doc => {
              const data = doc.data();
              return {
                title: data.title || "",
                city: data.city || "",
                country: data.country || "",
                emoji: data.emoji || "üçΩÔ∏è",
                user: data.user || "Anonymous",
                timestamp: data.timestamp || null
              };
            });

            renderFoodItems(allFoods);
          }, err => {
            console.error("Error fetching global foods:", err);
          });
      }

      // ===== Rendera global matlista =====
      function renderFoodItems(items) {
        foodList.innerHTML = "";
        if (!items.length) {
          foodList.innerHTML = "<p>No food found.</p>";
          return;
        }

        items.forEach(item => {
          const div = document.createElement("div");
          div.classList.add("food-item");
          div.innerHTML = `
            <span class="icon">${item.emoji}</span>
            <h3>${item.title}</h3>
            <p>Location: ${item.city}, ${item.country}</p>
            <p>Shared by: ${item.user}</p>
          `;
          foodList.appendChild(div);
        });
      }
    </script>
  </body>
</html>
